# M3U Checker Pro

![Dashboard Screenshot](https://via.placeholder.com/800x400?text=Dashboard+Screenshot)

✨ M3U Checker 是一个基于 Flask 的 IPTV 直播源检测工具，旨在帮助用户快速评估 M3U 订阅源中每个频道的可用性和质量。它通过并发请求和硬件加速解码，高效地测试频道的响应时间、分辨率、编码格式、码率等指标，并根据用户设定的分辨率过滤生成最优的播放列表（M3U/TXT）。内置计划任务功能，可定时自动更新，保持列表新鲜度。

---

## ✨ 主要特性

*   **多订阅管理**：支持同时管理多个 M3U 订阅源，每个源独立配置。

*   **频道探测**：
    *   检测 HTTP 状态、响应延迟、下载速度。
    *   通过 `ffprobe` 分析视频分辨率、编码（H264/HEVC/AV1 等）、帧率、码率。
    *   可选硬件加速（VAAPI/QSV）加速分析过程。

*   **智能过滤与排序**：
    *   根据用户选择的分辨率（SD/720P/1080P/4K/8K）过滤频道。
    *   综合评分排序（基于分辨率、速度、延迟），优先选择优质源。

*   **丰富的地理信息**：
    *   自动解析服务器 IP 所在地（城市、运营商）。
    *   统计各地区连通性，辅助选择最优线路。

*   **实时 Web 仪表盘**：
    *   展示探测进度、成功/失败统计。
    *   可视化图表（画质分布、延迟分布、编码统计等）。
    *   实时日志流，支持自动滚动/手动追踪。

*   **计划任务**：
    *   支持固定时间点（如每天 08:00, 20:00）或间隔小时自动执行探测。
    *   任务执行后自动更新 M3U/TXT 文件。

*   **硬件加速诊断**：
    *   内置 VA-API 检测工具，验证 GPU 驱动状态。
    *   支持 Intel QuickSync 和 VAAPI。

*   **输出格式**：
    *   生成标准 M3U 文件（包含 EPG 和台标信息）。
    *   生成简易 TXT 格式（频道名,URL），便于其他应用使用。
    *   每日 CSV 日志记录所有探测结果。

---

## 🚀 快速开始

### 使用 Docker Compose 部署（推荐）

1.  **克隆项目仓库**：

    ```bash
    git clone https://github.com/je668/m3u-checker-pro.git
    cd m3u-checker
    ```

2.  根据您的硬件情况编辑 `docker-compose.yml` 和 `hwaccel.transcoding.yml`（如需硬件加速）。

3.  **启动容器**：

    ```bash
    docker-compose up -d
    ```

4.  **访问 Web 界面**：`http://宿主机IP:5123`

### 环境变量说明

| 变量名           | 默认值          | 描述                                     |
| :--------------- | :-------------- | :--------------------------------------- |
| `TZ`             | `Asia/Shanghai` | 时区设置                                 |
| `USE_HWACCEL`    | `true`          | 是否启用硬件加速（需配置文件 `use_hwaccel` 配合） |
| `LIBVA_DRIVER_NAME` | `iHD`           | VAAPI 驱动名称（`iHD` 或 `i965`）        |
| `HW_ACCEL_TYPE`  | `vaapi`         | 硬件加速类型（`vaapi` 或 `qsv`）         |
| `VAAPI_DEVICE`   | `/dev/dri/renderD128` | VAAPI 设备路径                           |
| `QSV_DEVICE`     | `/dev/dri/renderD128` | QSV 设备路径                             |
| `DEBUG_HW`       | `0`             | 设为 `1` 开启硬件调试日志                |

### 硬件加速配置

容器需要访问主机的 DRM 设备，并拥有 `video` 和 `render` 组权限。`docker-compose.yml` 已通过 `devices` 和 `group_add` 配置好，无需额外操作。如需验证，可在容器内执行 `vainfo` 查看输出。

---

## 📖 使用指南

### 1. 添加订阅

点击左侧边栏的 **新增检测任务**，填写：

*   **名称**：自定义任务名。
*   **URL**：M3U 订阅地址（支持 HTTP/HTTPS）。
*   **保留分辨率**：勾选您希望保留的画质等级。
*   **线程数**：并发探测线程数（根据机器性能调整，建议 5-20）。
*   **模式**：
    *   **手动执行**：仅手动触发。
    *   **定时执行**：输入固定时间点（如 `08:00,20:00`），每天此时自动运行。
    *   **间隔循环**：输入间隔小时数（如 `6`），每 6 小时运行一次。
*   **启用此计划**：勾选后任务才会被调度。

点击 **保存同步**。

### 2. 执行探测

*   **手动执行**：在任务详情页点击 **立即执行**。
*   **自动执行**：根据设置的计划自动触发。

探测过程分为两个阶段：

1.  **地理位置预检**：批量查询各服务器 IP 所在地。
2.  **频道探测**：并发测试每个频道，实时更新日志。

### 3. 查看结果

*   **实时日志**：显示每个频道的探测结果，包括分辨率、编码、延迟、网速、地区等。
*   **统计卡片**：总频道数、已处理、有效源、有效率、熔断数。
*   **图表**：
    *   画质占比（4K/1080P/720P/SD）
    *   源有效率（成功/失败/熔断）
    *   响应延迟分布
    *   视频编码分布
    *   音频编码分布
*   **结算报告**：任务完成后，日志区会显示详细汇总，包括地区连通率、接口质量排名、运营商分布等。

### 4. 获取播放列表

*   **M3U 地址**：`http://你的IP:5123/sub/任务ID.m3u`
*   **TXT 地址**：`http://你的IP:5123/sub/任务ID.txt`

可将这些地址填入播放器（如 TiviMate、Kodi）或导入其他工具。

### 5. 全局设置

点击 **全局设置**，可配置：

*   **GPU 硬件加速探测**：开关。
*   **EPG 接口**：节目指南地址（用于 M3U 的 `x-tvg-url`）。
*   **台标路径**：频道图标基础 URL（将拼接 `频道名.png` 作为 `tvg-logo`）。
*   **网络测试**：检测宿主机 IPv4/IPv6 连通性。
*   **VA-API 诊断**：运行 `vainfo` 检测硬件加速状态。

---

## 📁 数据持久化

容器内数据目录 `/app/data` 映射到宿主机，包含：

*   `log/`：每日 CSV 日志（如 `2025-01-01.csv`）。
*   `output/`：生成的 M3U/TXT 文件及最后一次任务状态 JSON。
*   `config.json`：配置文件，包含所有订阅和设置。

---

## 🐛 故障排除

### GPU 加速未生效

*   在容器内运行 `vainfo` 检查输出，确保无错误。
*   确认主机的 `/dev/dri` 设备权限正确（`ls -l /dev/dri/renderD128` 应显示 `crw-rw----`，且容器内用户（root）在 `video` 和 `render` 组）。
*   设置环境变量 `DEBUG_HW=1` 重启容器，观察日志中硬件加速尝试记录。

### IPv4 测试失败

*   如果 `api4.ipify.org` 不可达，代码会自动尝试备用服务（`api.ip.sb`、`ipv4.icanhazip.com`）。若仍失败，检查宿主机网络连通性。

### 日志显示不全

*   Web 界面默认显示最近 500 条日志，如需查看更多，可查看持久化的 CSV 文件或任务结束后的 JSON 存档。

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request。请确保代码风格与现有一致，并更新相关文档。

---

## 📄 许可证

本项目采用 MIT 许可证。详见 [LICENSE](LICENSE) 文件。
